# interactive-feedback-mcp 功能说明

本文档详细介绍 `interactive-feedback-mcp` 服务的各项功能，旨在帮助用户全面了解其用途、交互方式以及与 AI 助手的协作流程。

## 快速开始

### 安装方式

**推荐方式（uvx）：**
```bash
uvx interactive-feedback@latest
```

**或使用pip：**
```bash
pip install interactive-feedback
```

**当前版本：** v2.5.5 - 修复了 uvx 安装模式下的兼容性问题和优化按钮布局

**PyPI项目页面：** https://pypi.org/project/interactive-feedback/

### MCP配置示例
```json
{
  "mcpServers": {
    "interactive-feedback": {
      "command": "uvx",
      "args": ["interactive-feedback@latest"],
      "timeout": 600,
      "autoApprove": ["interactive_feedback"]
    }
  }
}
```

详细安装和配置说明请参阅 [安装与配置指南.md](./安装与配置指南.md)。

## 1. 项目简介

`interactive-feedback-mcp` 是一个模型上下文协议 (MCP) 服务，它通过在 AI 助手（如 Cursor）需要用户输入、澄清或确认时，弹出一个功能丰富的图形用户界面 (GUI) 反馈窗口。此服务旨在提升人与 AI 之间协作的效率、准确性和灵活性，支持文本、图片以及文件引用等多种反馈形式。

## 2. 核心功能

### 2.1. 交互式反馈窗口

*   **触发方式**：
    *   AI 助手通过调用本 MCP 服务提供的 `interactive_feedback` 工具时，会自动弹出反馈窗口。
    *   用户也可以主动告知 AI 助手："请用 `interactive_feedback mcp` 工具与我对话"来手动触发。
*   **文本输入**：用户可以在主输入框中输入纯文本反馈。支持通过按 `Enter`键发送反馈，按 `Shift+Enter` 组合键进行换行。
*   **预定义选项**：如果 AI 助手在调用时提供了 `predefined_options` 参数，这些选项会以带文本描述的复选框形式显示。用户可以直接勾选一个或多个选项，选中的选项文本会自动整合到最终发送的反馈内容中。

### 2.2. 图片处理与反馈

*   **图片粘贴**：用户可以直接在反馈输入框中使用 `Ctrl+V` (或 macOS 上的 `Cmd+V`) 粘贴剪贴板中的单张或多张图片。
*   **图片拖拽**：支持从本地文件系统直接拖拽图片文件到文本输入框中进行添加。
*   **图片预览与管理**：
    *   添加的图片会在文本输入框下方以缩略图形式显示。
    *   鼠标悬停在缩略图上会显示更大尺寸的图片预览及图片尺寸信息。
    *   点击缩略图可以直接删除该图片。
*   **图片处理机制**：为了优化传输和 AI 处理，图片在发送前会进行处理：
    *   尺寸调整：较大的图片会被缩放到预设的最大宽度和高度（例如 512x512 像素），同时保持宽高比。
    *   格式与压缩：图片统一转换为 JPEG 格式，并可能根据需要调整压缩质量以满足大小限制（例如 1MB）。
*   **发送方式**：图片数据会经过 Base64 编码后，与文本内容一起作为结构化数据返回给 AI 助手。

### 2.3. 文件处理

*   **文件拖拽**：将本地文件拖拽到文本输入框，生成蓝色加粗的文件引用（如 `@文件名.txt`）。
*   **文件选择**：点击"选择文件"按钮打开文件选择对话框，支持多文件选择。
*   **智能处理**：自动识别图片文件和普通文件，分别进行相应的处理和显示。
*   **智能光标定位**：文件添加后光标自动定位到合适位置，便于继续输入。

### 2.4. 常用语管理

*   **预设管理**：预设和管理常用的反馈短语，支持添加、编辑、删除和排序。
*   **快速预览**：鼠标悬停在"常用语"按钮上显示预览窗口，支持滚动查看所有常用语。
*   **快速插入**：在预览窗口中点击常用语直接插入到输入框，或通过管理对话框双击插入。
*   **主题适配**：预览窗口和管理界面支持深色/浅色主题切换。

### 2.5. 终端功能

*   **多终端支持**：支持PowerShell、Git Bash、Command Prompt三种终端类型。
*   **原生体验**：直接在终端输出区域输入命令，支持命令历史、键盘导航等完整终端功能。
*   **彩色输出**：支持ANSI转义序列，正确显示颜色、格式和中文内容。
*   **智能识别**：自动识别不同终端的提示符格式，在显示和输入模式间自动切换。
*   **窗口管理**：终端窗口支持独立的大小调整、位置记忆、置顶显示等功能。

### 2.6. 界面布局

*   **双布局模式**：支持垂直布局（上下分布）和水平布局（左右分布）。
*   **可拖拽分割器**：支持拖拽分割器调整各区域大小，双击重置为默认比例。
*   **实时切换**：在设置页面可以实时切换布局模式，状态自动保存。

### 2.7. 文本优化功能

*   **一键优化**：将口语化输入转换为结构化、逻辑清晰的指令。
*   **自定义增强**：支持用户自定义增强指令，按特定要求处理文本内容。
*   **多AI提供商**：支持OpenAI、Google Gemini、DeepSeek、火山引擎等多个AI提供商。
*   **API密钥管理**：通过设置页面统一管理所有提供商的API密钥。
*   **优化体验**：支持加载动画、撤销功能（Ctrl+Z）、自动光标定位等。

### 2.8. 其他功能

*   **音频提示**：窗口弹出时自动播放提示音，支持自定义音频文件。
*   **窗口截图**：支持矩形选择截图，截图完成后自动添加到输入内容中。
*   **显示模式**：支持简单模式（显示简洁问题）和完整模式（显示完整回复），可在设置页面实时切换。
*   **窗口控制**：支持窗口固定、自动最小化、UI状态持久化等功能。



## 3. 提供的 MCP 工具

本服务通过 MCP 向 AI 助手公开以下核心工具：

### `interactive_feedback`

*   **功能**：向用户发起交互式会话，显示提示信息，提供可选选项，并收集用户的文本、图片和文件引用反馈。
*   **参数**：
    *   `message` (str, 可选): 简单模式下显示的简洁问题或提示
    *   `full_response` (str, 可选): 完整模式下显示的AI原始完整回复内容
    *   `predefined_options` (List[str], 可选): 一个字符串列表，每个字符串代表一个用户可以选择的预定义选项。如果提供，这些选项会显示为复选框。
*   **显示模式说明**：
    *   **简单模式**：优先使用 `message` 参数内容，显示简洁的问题或提示
    *   **完整模式**：优先使用 `full_response` 参数内容，显示完整的AI回复
    *   **智能回退**：如果主要参数为空，自动回退到备用参数，避免调用失败
    *   **实时模式检测**：每次调用都读取最新的用户模式配置，支持动态切换
*   **返回给AI助手的数据格式**：
    该工具会返回一个包含结构化反馈内容的元组 (Tuple)。元组中的每个元素可以是字符串 (文本反馈或文件引用信息) 或 `fastmcp.Image` 对象 (图片反馈)。
    具体来说，从UI收集到的数据会转换成以下 `content` 项列表，并由 `server.py` 进一步处理成 FastMCP兼容的元组：
    ```json
    // UI返回给server.py的原始JSON结构示例
    {
      "content": [
        {"type": "text", "text": "用户的文本反馈..."},
        {"type": "image", "data": "base64_encoded_image_data", "mimeType": "image/jpeg"},
        {"type": "file_reference", "display_name": "@example.txt", "path": "/path/to/local/example.txt"}
        // ... 可能有更多项
      ]
    }
    ```
    *   **文本内容** (`type: "text"`)：包含用户输入的文本和/或选中的预定义选项组合文本。
    *   **图片内容** (`type: "image"`)：包含 Base64 编码后的图片数据和图片的 MIME 类型 (如 `image/jpeg`)。这些在 `server.py` 中会被转换为 `fastmcp.Image` 对象。
    *   **文件引用** (`type: "file_reference"`)：包含用户拖拽的文件的显示名 (如 `@filename.txt`) 和其在用户本地的完整路径。这些信息通常会作为文本字符串传递给AI助手。

    **注意**：即使没有任何用户输入（例如用户直接关闭反馈窗口），工具也会返回一个表示"无反馈"的特定消息，如 `("[User provided no feedback]",)`。

### `optimize_user_input`

*   **功能**：使用配置的LLM API来优化或增强用户输入的文本，将口语化、可能存在歧义的输入转化为更结构化、更清晰、更便于AI模型理解的文本。
*   **参数**：
    *   `original_text` (str): **必须参数**。用户的原始输入文本
    *   `mode` (str): **必须参数**。优化模式：
        *   `'optimize'`: 一键优化，使用预设的通用优化指令
        *   `'reinforce'`: 提示词强化，使用用户自定义的强化指令
    *   `reinforcement_prompt` (str, 可选): 在 'reinforce' 模式下用户的自定义指令
*   **支持的AI提供商**：
    *   **OpenAI**: GPT-4o-mini 等模型，提供高质量的文本优化
    *   **Google Gemini**: Gemini-2.0-flash 等模型，快速响应和处理
    *   **DeepSeek**: DeepSeek-chat 等模型，成本效益优化
    *   **火山引擎**: DeepSeek-v3 等模型，国内访问优化
*   **配置要求**：
    *   需要在UI设置页面配置相应提供商的API密钥
    *   支持自定义优化和增强提示词
    *   提供完善的错误处理和重试机制
*   **返回**：优化后的文本内容或详细的错误信息

## 4. 界面与体验特性

*   **深色主题UI**：界面采用深色主题，提供舒适的视觉体验。
*   **快捷键支持**：支持Enter提交、Shift+Enter换行、Ctrl+V粘贴等快捷键操作。
*   **智能交互**：输入框智能提示、hover预览、流畅的鼠标交互体验。
*   **响应式布局**：界面支持不同布局模式，能根据窗口大小自动调整元素排列。
*   **富文本支持**：支持带颜色的文件引用显示和文本格式化。